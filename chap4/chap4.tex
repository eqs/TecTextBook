\renewcommand{\myincludegraphics}[2]{\includegraphics[#2]{chap4/#1}}

\chapter{マイコンの操作\label{sousa}}
%\setcounter{page}{25}

この章では，
マイコン（TeC）の操作方法を学習します．
併せてマイコンの内部にあるレジスタや記憶装置も憶えましょう．
%この章に掲載している写真はTeC7のものです．
%TeC6とはコネクタの構成が異なりますが，
%コンソールパネルの構成，操作方法，内部構造は共通です．

\section{各部の名称}
\figref{chap4:kakubu}に，マイコン各部の名称(または役割り)を示します．
各部の役割りは次の通りです．

\myfigureNA{tbp}{scale=0.8}{kakubu.pdf}{各部の名称}{chap4:kakubu}

\begin{enumerate}
\item コンソールパネル \\
マイコンにプログラムを入力したり，
マイコンの内部を観察したり，
プログラムの実行を指示したりするために使用する部分です．
データの入力や表示は2進数を用います．
本マイコンの顔です．
\item リセットスイッチ \\
マイコンをリセットする押しボタンスイッチです．
\item ジャンパ \\
マイコンのモードを切替えます．
通常は，「TeC」の位置にジャンパーを挿して「TeC モード」で使用します．
高学年で「TaC モード」を使用します．
「DEMO1 モード」，「DEMO2 モード」は，
電子オルゴールのデモプログラムが予め入力された状態になるモードです．
\item スピーカー \\
コンソールパネルを操作したとき，
操作を確認するための音を出します．
また，マイコンに入力したプログラムで音を出すこともできます．
\item 電源コネクタ \\
マイコンに電力を供給するコネクタです．
付属のアダプタに USB ケーブルを用いて接続します．
USB ケーブルでパソコンと接続して通信させることも可能です．
\item キーボードコネクタ \\
パソコン用の PS/2 キーボードを接続することができます．
この機能は，「TaC モード」で使用します．
\item ディスプレイコネクタ \\
パソコン用の ディスプレイを接続することができます．
この機能は，「TaC モード」で使用します．
\item $\mu SD$ スロット \\
携帯電話などで使用する $\mu SD$ メモリカードを挿入します．
この機能は，「TaC モード」で使用します．
\item JTAGコネクタ \\
マイコン本体の回路を変更するとき使用します．
\item 入出力ポートコネクタ \\
マイコンの外部に追加の回路を接続するために使用します．
\end{enumerate}

\section{コンソールパネル}
\figref{chap4:console}にコンソールパネルの様子を示します．
この図を見ながら以下を読んで下さい．

\myfigureNA{tbp}{scale=1.2}{console.pdf}{コンソールパネル}{chap4:console}

\subsection{コンソールパネルの構成}
コンソールパネルは，以下のランプやスイッチにより構成されています．
コンソールパネルが，マイコンボードの約半分の面積を使用していますが，
これは，操作性を考慮した結果です．これ以上，小さくするとスイッチの
間隔が狭くなり過ぎ，操作性が悪くなります．

\subsubsection{アドレスランプ}
最上段の8個の赤ランプはアドレスランプです．
アドレスランプは，
主記憶を操作するとき，
操作対象となる主記憶の番地（アドレス）を表示します．
ランプは点灯している状態が2進数の'1'，
消灯している状態が2進数の'0'を表現しています．

\subsubsection{データランプ}
上から2段目の8個の緑ランプは，
選択されたレジスタまたは主記憶の内容を表示します．

\subsubsection{ロータリースイッチ}
上から3段目の6個の黄色ランプと左右の押しボタンスイッチは，
ロータリースイッチの代用です．
通常のロータリースイッチは背が高く，
ビデオカセットケースにマイコンを収めるための障害になるのでこのようにしました．

ランプのうち一つが点灯し，
レジスタ(G0，G1，G2，SP，PC)または主記憶(MM:Main Memory)のどれ
が選択されているか表示します．
左右の押しボタンスイッチ(←，→)によって，
点灯するランプを変更することができます．
ロータリースイッチで選択されたものの内容が，
データランプに表示されます．

\subsubsection{データスイッチ}
8個のトグルスイッチはデータやアドレスの値を入力するためのものです．
トグルスイッチを上に倒して2進数の'1'を，
下に倒して2進数の'0'を入力します．

\subsubsection{機能スイッチ}
一番下の列の8個のスイッチには，
様々な機能が割り当てられています．
左から順に，ブレークポイントモード(BREAK)，
ステップ実行モード(STEP)，
プログラム実行する(RUN)，
プログラム停止する(STOP)，
アドレスをセットする(SETA)，
アドレスを進める(INCA)，
アドレスを戻す(DECA)，
書き込む(WRITE)
の機能を持ちます．
押しボタンスイッチは，長押しでリピート機能が働きます．

\subsubsection{実行ランプ}
右上のRUNランプは，CPUがプログラムを実行中であることを表します．
CPUが正しくない命令を実行した場合は点滅して異常を知らせます．

\subsubsection{フラグランプ}
実行ランプ下の三つの黄色ランプC(Carry)，S(Sign)，Z(Zero)は，
フラグの値を表示します．

\subsection{コンソールパネルの操作方法}
\label{operation}
コンソールパネルから
プログラムを実行させたり実行を途中で止めたりすることができます．
また，\figref{chap4:naibu}に示すTeC内部の情報にアクセスすることができます．
TeCの内部には3ビットのフラグ，8ビットのレジスタが5個，
$8ビット \times 256$のメモリが内蔵されています．
以下では，コンソールパネルの操作方法を目的別に説明します．

\myfigureN{tbp}{width=\columnwidth}{naibu.pdf}{TeCの記憶装置}{chap4:naibu}

\subsubsection{フラグの表示}
フラグの状態はC，S，Zの三つのランプに常時表示されています．
フラグの値を表示するために何も操作をする必要はありません．
フラグの値をコンソールパネルから変更する方法は用意されていません．

\subsubsection{レジスタの表示と書き換え}
五つのレジスタ(G0，G1，G2，SP，PC)を表示する方法と，
書き換える方法を説明します．
レジスタの値は緑色のデータランプに表示されます．
8個のランプで8ビットの情報を表現します．
どのレジスタをデータランプに表示するかは
ロータリースイッチで選択します．
\vspace{0.3cm}

レジスタの値を書き換える手順は，次の通りです．
\begin{enumerate}
\item ロータリースイッチで目的のレジスタを選択する．
\item 書き込むデータをデータスイッチにセットする．
\item {\bf WRITEスイッチ}を押す．
\end{enumerate}

\subsubsection{主記憶(メモリ)のアドレス指定}
\figref{chap4:naibu}を見ると分かるように，
メモリには $00_{16}$ 〜 $FF_{16}$
 (2進数で表現すると $0000~0000_{2}$ 〜 $1111~1111_{2}$)
の番地(アドレス)が付けられています．
メモリへ対する表示や書き換え等の操作は1アドレス(8ビット)毎に行います．
%操作対象となるメモリのアドレスを指定した上で行う必要があります．
メモリ・アドレスは，{\bf アドレスランプ}にセットすることで指定します．
アドレスランプにアドレスをセットする方法は次の通りです．

\begin{enumerate}
\item ロータリースイッチをMMに合わせる．
\item アドレスをデータスイッチにセットする．
\item {\bf SETA(Set Address)スイッチ}を押す．\\
(アドレスがアドレスランプに表示される．)
\item アドレスを次の番地に進めたいときは，\\
{\bf INCA(Increment Address)スイッチ}を押す．
\item アドレスを前の番地に戻したいときは，\\
{\bf DECA(Decrement Address)スイッチ}を押す．
\end{enumerate}

\subsubsection{主記憶(メモリ)の表示}
アドレスランプにアドレスをセットするだけです．

\begin{enumerate}
\item ロータリースイッチをMMに合わせる．
\item 目的のアドレスをアドレスランプで指定する．
\item データランプにメモリの内容が表示される．
%\item 別の番地の内容を表示したいときは
%SETA，INCA，DECA等のスイッチでアドレスランプの表示を変更する．
\end{enumerate}

\subsubsection{主記憶(メモリ)の書き換え}
アドレスを指定して書き換えます．

\begin{enumerate}
\item 上の手順で目的のメモリ番地の内容を表示する．
\item データスイッチに書き込みたい値をセットする．
\item {\bf WRITEスイッチ}を押す．
\item メモリにデータが書き込まれる．
\end{enumerate}

なお，{\bf WRITEスイッチ}を押したとき，
アドレスが自動的に次の番地に変化します．
これは，連続したデータの書き込みに便利だからです．

\subsubsection{プログラムの実行}
%ノイマン型のコンピュータは，
%{\bf 「プログラム内蔵方式(ストアードプログラム方式)」}を
%採用しているのが特徴です．
%「プログラム内蔵方式」とは，データだけでなくプログラムもメモリに
%記憶する方式です．
%TeCもプログラム内蔵方式ですので，

%ノイマン型コンピュータのもう一つの特徴として，
%{\bf 「逐次実行」}があげられます．
%「逐次実行」とは，メモリに記憶したプログラムの命令を
%アドレス順に一つ一つ順番に実行することを言います．
%次に実行する命令のアドレスは，
%PCレジスタが記憶しています．

%つまり，コンソールパネルからデータを書き込む方法を知っていれば，
%プログラムを書き込むこともできます．

プログラムはメモリにデータと同様に書き込みます．
プログラムの開始番地をPCにセットすることでTeCがプログラムの場所を認識します．
以下にプログラムを実行する手順を，例\ref{sousa}-1に実行例を示します．

\begin{enumerate}
\item プログラムをメモリに書き込む．
\item プログラムの開始番地をPCに書き込む．
\item {\bf BREAK，STEPスイッチ}を下に倒す．
\item {\bf RUNスイッチ}を押す．(RUNランプ点灯)
\item プログラムの実行終了．(RUNランプ消灯)
\end{enumerate}

\begin{figure}[tb]
\fbox{\parbox{0.9\columnwidth}{\parindent=1zw
\subsection*{例\ref{sousa}-1 最も簡単なプログラムの実行}

下は，何もしない命令(NO命令)を三つ実行した後，
停止命令(HALT命令)を実行して停止するプログラムです．
このプログラムを打ち込んで実行します．

{\tt\small\begin{center}
最も簡単なプログラムのリスト
\begin{tabular}{|c|c|c|} \hline
番地 & 命令 & 命令の種類\\
\hline
$00_{16}$ & $00_{16}$ & NO \\
$01_{16}$ & $00_{16}$ & NO \\
$02_{16}$ & $00_{16}$ & NO \\
$03_{16}$ & $FF_{16}$ & HALT \\
\hline
\end{tabular}
\end{center}}

\subsubsection{プログラム打ち込み手順}

\begin{enumerate}
\item ロータリースイッチをMMに合わせる．
\item アドレスランプに$00_{16}$をセットする．
\item データスイッチに$00_{16}$をセットする．
\item WRITEスイッチを3回押し
メモリ$00_{16}$番地〜$02_{16}$番地に$00_{16}$を書き込む．
\item データスイッチに$FF_{16}$をセットする．
\item WRITEスイッチを押しメモリ$03_{16}$番地に$FF_{16}$を書き込む．
\end{enumerate}

\subsubsection{プログラム実行手順}

\begin{enumerate}
\item ロータリースイッチをPCに合わせる．
\item データスイッチに$00_{16}$をセットする．
\item WRITEスイッチを押しPCを$00_{16}$にする．
\item BREAK，STEPスイッチを下に倒す．
\item RUNスイッチを押し実行を開始する．
\item 一瞬でプログラム実行が終了する．
\item PCは，HALT命令実行後なので，その次の番地 $04_{16}$を指している．
\item 何もしない命令と停止命令しか実行していないので，
PC以外のレジスタ，フラグ，メモリに変化はない．
\end{enumerate}
}}
\end{figure}

\subsubsection{プログラムのステップ実行}
\label{step}
プログラム中の命令を
1命令ずつ実行することを{\bf ステップ実行}と言います．
作ったプログラムが予定通りに動かないとき
原因を調べるために使用します．
(このような作業を{\bf デバッグ}と言います．)
以下にステップ実行の手順を，
例\ref{sousa}-2にステップ実行の例を示します．

\begin{enumerate}
\item プログラムをメモリに書き込む．
\item プログラムの開始番地をPCレジスタに書き込む．
\item {\bf STEPスイッチ}が上に倒れていることを確認する．
(倒れていなかった場合は倒す．)
\item {\bf RUNスイッチ}を押す．
\item PCにセットしてあった番地の1命令が実行され，プログラムが停止する．
\item レジスタやメモリの状態が予想通りか確認する．
\item 確認が終わったらRUNスイッチを押して，次の命令を実行させる．
\item プログラムの終わりまで以上の操作を繰り返す．
\end{enumerate}

\begin{figure}[tb]
\fbox{\parbox{0.9\columnwidth}{\parindent=1zw
\subsection*{例\ref{sousa}-2 プログラムのステップ実行}

前の例と同じプログラムをステップ実行モードで実行してみます．

\subsubsection{プログラムの実行手順}
\begin{enumerate}
\item 前の例と同様にプログラムを打ち込む．
\item STEPスイッチを上に倒して(ステップ実行モードにして)，
前の例と同様にプログラムの実行を開始する．
\item ステップ実行モードなので
$00_{16}$番地の命令だけを実行し停止する．
このとき，PCは次命令の番地 $01_{16}$を指している．
\item 再度RUNスイッチを押すと，
$01_{16}$番地の命令を実行しPCが $02_{16}$ を指して停止する．
\item 以後，RUNスイッチを押す度に，1命令実行しては停止する．
\end{enumerate}
}}
\end{figure}

\subsubsection{ブレークポイントを使用した実行}
デバッグをするときに目的の命令まで一気に進んでから，
ステップ実行をしたい場合があります．
そのとき，一気に目的の命令まで進むのにブレークポイントを使用できます．
ブレークポイントとは，プログラムの実行を停止する場所(アドレス)のことです．
次のような手順になります．

\begin{enumerate}
\item プログラムをメモリに書き込む．
\item プログラムの開始番地をPCレジスタに書き込む．
\item {\bf BREAKスイッチが上}に{\bf STEPスイッチが下}に倒れていることを確認する．\\
(倒れていなかった場合は倒す．)
\item プログラムの実行を停止させる命令のアドレスをデータスイッチにセットする．
\item {\bf RUNスイッチ}を押す．
\item データスイッチで指定したアドレスの命令を{\bf 実行後}，停止する．
\end{enumerate}

\begin{figure}[tb]
\fbox{\parbox{0.9\columnwidth}{\parindent=1zw
\subsection*{例\ref{sousa}-3 ブレークポイントモードでの実行}
前の例と同じプログラムをブレークポイントモードで実行してみます．

\subsubsection{プログラムの実行手順}
\begin{enumerate}
\item 前の例と同様にプログラムを打ち込む．
\item 実行を停止したい命令のアドレス(今回は，$01_{16}$)を
データスイッチにセットする．
\item STEPスイッチを{\bf 下}に，BREAKスイッチを{\bf 上}に倒して
(ブレークポイントモードにして)，前の例と同様にプログラムの実行を開始する．
\item ブレークポイントモードなので$01_{16}$番地の命令を実行したら停止する．
このとき，PCは次命令の番地 $02_{16}$を指している．
\item 再度RUNスイッチを押すと $02_{16}$番地からプログラムの実行を再開する．
\item $03_{16}$番地にはHALT命令が格納されているので実行が停止する．
\end{enumerate}
}}
\end{figure}

\section{リセットスイッチ}
基板の左下にあるRESETと書かれた押しボタンスイッチのことです．
TeCをリセットしたいときに使用します．
リセットスイッチを押すと，フラグ，レジスタ，アドレスランプ，
TeCに内蔵された入出力装置の状態が(`0'に)クリアされます．
メモリの内容と，ロータリースイッチの状態はクリアされません．

\section{操作音を小さくする}
押しボタンスイッチを押すと，
ボタンが押されたことが確認できるように，
「ピッ」と短い電子音が鳴るようになっています．
しかし，静かな部屋で使用する場合，この音が邪魔になります．

このようなときは，
{\bf STOPスイッチ}を押しながら{\bf RESETスイッチ}を押して下さい．
電子音が，かすかに聞こえる「プッ」という音に変わります．

\section{モード}
これまで操作方法を説明してきたマイコンボード（{\bf TeC7}と呼びます．）は，
TeCとして使用できるだけではなく，
2進数の入力練習用に楽譜を打込める電子オルゴールとして使用したり，
もっと高度な学習をするためにパソコンのように使用したりすることができます．
以下のようにジャンパの設定を変更してから電源を入れることで
モードを切替えることができます．

\myfigureNA{tb}{scale=0.8}{data.pdf}{電子オルゴールデータ}{chap4:doremi}

\begin{description}
\item[TeCモード]
ジャンパを{\bf TeC}の位置（上側）に挿入してから電源を入れます．
TeC7をTeCとして使用できる通常のモードです．

\item[DEMO1モード]
ジャンパを{\bf DEMO1}の位置（左側）に挿入してから電源を入れます．
このモードはTeCモードの変形バージョンです．
TeCの主記憶の80H番地からBFH番地の間に
予め電子オルゴールプログラムを書き込んだ状態になります．
音楽データを00H番地から打ち込んで{\bf RESET}，
{\bf RUN}の順にボタンを押すと演奏が始まります．
2進数データをTeCに入力する練習用に使用します．

\item[DEMO2モード]
ジャンパを{\bf DEMO2}の位置（右側）に挿入してから電源を入れます．
このモードもTeCモードの変形バージョンです．
TeCの主記憶の00H番地からBFH番地の間に予
め電子オルゴールプログラムと音楽データを書き込んだ状態になります．
{\bf RESET}，{\bf RUN}の順にボタンを押すと
予め書き込まれた音楽データの演奏が始まります．

\item[TaCモード]
ジャンパを{\bf TaC}の位置（下側）に挿入してから電源を入れます．
このモードでは，TeC7が{\bf 16ビット版TeC}として動作します．
{\bf 16ビット版TeC}のことを{\bf TaC}と呼びます．
TaCは{\bf TacOS}（\url{https://github.com/tctsigemura/TacOS}）を実行できる
パソコンのようなコンピュータです．
\end{description}

%\newpage
\section*{演習}

電子オルゴールのデータをTeCに打ち込みなさい．
手順は次の通りです．

\begin{enumerate}
\item ジャンパをDEMO1の位置に差し込んで電源を投入し
TeCを{\bf DEMO1モード}にする．
\item 電子オルゴールデータは\figref{chap4:doremi}を参照し
自分の好きな曲を入力する．
例えば，４分音符の{\bf ド}，{\bf レ}，{\bf ミ}を連続して入力する場合は，
次の表のように主記憶にデータを打込む．

{\tt\small\begin{center}
\begin{tabular}{| c | c | l }\cline{1-2}
アドレス  & データ \\\cline{1-2}
0000 0000 & 1000 0011 & ド   \\
0000 0001 & 1110 1000 &      \\
0000 0010 & 1001 0011 & レ   \\
0000 0011 & 1101 0001 &      \\
0000 0100 & 1010 0101 & ミ   \\
0000 0101 & 1011 1010 &      \\
0000 0110 & 0000 0000 & 終了 \\
  ...     &   ...     &      \\
1111 1111 & 0000 0000 &      \\\cline{1-2}
\end{tabular}
\end{center}}

\item {\bf RESET}，{\bf RUN}の順にボタンを押し演奏を試す．

\item 演習が終わったらジャンパーをTeCの位置に戻す．
\end{enumerate}
